<!-- Admin Edit Dorm Component -->

<!-- Back Button -->
<div class="max-w-4xl mx-auto mb-6">
  <button
    type="button"
    (click)="onClose.emit()"
    class="flex items-center text-gray-600 hover:text-gray-900 transition-colors"
  >
    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
    </svg>
    ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏û‡∏±‡∏Å
  </button>
</div>

<!-- Stepper (RED) -->
<div class="flex justify-center my-10">
  <div class="flex items-center w-full max-w-xl">
    <!-- Step 1 -->
    <div class="flex justify-center items-center relative">
      <div
        class="w-10 h-10 rounded-full flex justify-center items-center text-white cursor-pointer transition-colors"
        [ngClass]="{
          'bg-red-500': currentStep >= 1,
          'bg-gray-300': currentStep < 1
        }"
        (click)="goToStep(1)"
        title="‡πÄ‡∏û‡∏¥‡πà‡∏°"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 4.5v15m7.5-7.5h-15"
          />
        </svg>
      </div>
    </div>

    <!-- Connector 1‚Äì2 -->
    <div
      class="relative flex-1 h-px mx-2 rounded overflow-hidden"
      [ngClass]="{
        'bg-red-500': currentStep >= 2,
        'bg-gray-300': currentStep < 2
      }"
    >
      <div *ngIf="currentStep === 1" class="absolute inset-0">
        <div
          class="h-full w-1/2 bg-gradient-to-r from-transparent via-red-500 to-transparent opacity-90 animate-connector"
        ></div>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="flex justify-center items-center relative">
      <div
        class="w-10 h-10 rounded-full flex justify-center items-center text-white cursor-pointer transition-colors"
        [ngClass]="{
          'bg-red-500': currentStep >= 2,
          'bg-gray-300': currentStep < 2,
          'cursor-not-allowed': maxReachedStep < 2
        }"
        (click)="goToStep(2)"
        title="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M2.25 12c0 0 3.75-6.75 9.75-6.75S21.75 12 21.75 12s-3.75 6.75-9.75 6.75S2.25 12 2.25 12z"
          />
          <circle cx="12" cy="12" r="3" />
        </svg>
      </div>
    </div>

    <!-- Connector 2‚Äì3 -->
    <div
      class="relative flex-1 h-px mx-2 rounded overflow-hidden"
      [ngClass]="{
        'bg-red-500': currentStep >= 3,
        'bg-gray-300': currentStep < 3
      }"
    >
      <div *ngIf="currentStep === 2" class="absolute inset-0">
        <div
          class="h-full w-1/2 bg-gradient-to-r from-transparent via-red-500 to-transparent opacity-90 animate-connector"
        ></div>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="flex justify-center items-center relative">
      <div
        class="w-10 h-10 rounded-full flex justify-center items-center text-white cursor-pointer transition-colors"
        [ngClass]="{
          'bg-red-500': currentStep >= 3,
          'bg-gray-300': currentStep < 3,
          'cursor-not-allowed': maxReachedStep < 3
        }"
        (click)="goToStep(3)"
        title="‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="2"
          stroke="currentColor"
          class="w-5 h-5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M9 12.75l2.25 2.25L15 9.75m6 2.25a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
      </div>
    </div>
  </div>
</div>

<form [formGroup]="dormForm" (ngSubmit)="onSubmit()" [class.pointer-events-none]="isInitialLoading" [class.opacity-60]="isInitialLoading">
  <div class="max-w-4xl mx-auto bg-white rounded-lg border border-gray-200 p-8">
    <!-- ==================== Step 1 ==================== -->
    <div *ngIf="currentStep === 1" class="space-y-8">
      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -->
      <div formGroupName="generalInfo">
        <h3
          class="text-xl font-semibold text-gray-800 mb-6 pb-3 border-b border-gray-200"
        >
          ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label
              for="name"
              class="block mb-2 text-sm font-medium text-gray-700"
              >‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏û‡∏±‡∏Å <span class="text-red-500">*</span></label
            >
            <input
              id="name"
              type="text"
              formControlName="name"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF] transition-colors"
              placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏û‡∏±‡∏Å"
            />
          </div>

          <div>
            <label
              for="zone"
              class="block mb-2 text-sm font-medium text-gray-700"
              >‡πÇ‡∏ã‡∏ô <span class="text-red-500">*</span></label
            >
            <div class="relative">
              <select
                id="zone"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-0 focus:border-[#007AFF] focus:shadow-none transition-colors appearance-none pr-12 bg-white text-gray-700"
                formControlName="zone_id"
              >
                <option *ngFor="let z of zones" [ngValue]="z.zone_id">
                  {{ z.zone_name }}
                </option>
              </select>
              <span
                *ngIf="!dormForm.get('generalInfo.zone_id')?.value"
                class="pointer-events-none absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"
                >‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ã‡∏ô</span
              >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="2"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M19.5 8.25l-7.5 7.5-7.5-7.5"
                />
              </svg>
            </div>
            <div *ngIf="zonesLoading" class="text-xs text-gray-500 mt-1">
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ã‡∏ô...
            </div>
            <div *ngIf="zonesError" class="text-xs text-red-600 mt-1">
              {{ zonesError }}
            </div>
          </div>
        </div>

        <div class="mt-6">
          <label
            for="address"
            class="block mb-2 text-sm font-medium text-gray-700"
            >‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà <span class="text-red-500">*</span></label
          >
          <input
            id="address"
            type="text"
            formControlName="address"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF] transition-colors"
            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å"
          />
        </div>

        <div class="mt-6">
          <label
            for="description"
            class="block mb-2 text-sm font-medium text-gray-700"
            >‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° <span class="text-red-500">*</span></label
          >
          <textarea
            id="description"
            rows="5"
            formControlName="description"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-0 focus:border-[#007AFF] focus:shadow-none transition-colors min-h-[120px] appearance-none resize-y"
            placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
          ></textarea>
        </div>

        <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏≠‡∏û‡∏±‡∏Å (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) -->
        <div class="mt-6" *ngIf="isEditMode">
          <label class="block mb-3 text-sm font-medium text-gray-700">
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏≠‡∏û‡∏±‡∏Å <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-4">
            <label class="flex items-center space-x-3 cursor-pointer group">
              <input
                type="radio"
                formControlName="statusDorm"
                value="‡∏ß‡πà‡∏≤‡∏á"
                class="w-5 h-5 text-green-600 border-gray-300 focus:ring-2 focus:ring-green-500 cursor-pointer"
              />
              <span class="flex items-center gap-2 text-gray-700 group-hover:text-green-600 transition-colors">
                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <span class="font-medium">‡∏ß‡πà‡∏≤‡∏á</span>
                <span class="text-sm text-gray-500">(‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á)</span>
              </span>
            </label>

            <label class="flex items-center space-x-3 cursor-pointer group">
              <input
                type="radio"
                formControlName="statusDorm"
                value="‡πÄ‡∏ï‡πá‡∏°"
                class="w-5 h-5 text-red-600 border-gray-300 focus:ring-2 focus:ring-red-500 cursor-pointer"
              />
              <span class="flex items-center gap-2 text-gray-700 group-hover:text-red-600 transition-colors">
                <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <span class="font-medium">‡πÄ‡∏ï‡πá‡∏°</span>
                <span class="text-sm text-gray-500">(‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß)</span>
              </span>
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-2 ml-1">
            üí° ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡πÄ‡∏ï‡πá‡∏°" ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏≠‡∏û‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ
          </p>
        </div>
      </div>

      <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á -->
      <div formArrayName="roomTypes" class="space-y-4">
        <h3
          id="room-types-header"
          class="text-xl font-semibold text-gray-800 mb-6 pb-3 border-b border-gray-200"
        >
          ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á
        </h3>

        <div
          *ngFor="let roomType of roomTypes.controls; let i = index"
          [formGroupName]="i"
          [id]="'room-type-' + i"
          class="border border-gray-300 rounded-md p-4 bg-white room-type-container"
        >
          <div class="flex justify-between items-center mb-4">
            <span
              [id]="'room-type-header-' + i"
              class="font-medium text-gray-800"
              >‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà {{ i + 1 }}</span
            >
            <button
              type="button"
              (click)="removeRoomType(i)"
              class="text-red-500 hover:underline text-sm"
            >
              ‡∏•‡∏ö
            </button>
          </div>

          <div class="space-y-3 md:space-y-4">
            <!-- ‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ã‡πâ‡∏≤‡∏¢ (dropdown ‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô) ‡∏Ç‡∏ß‡∏≤ (‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
              <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ï‡∏µ‡∏¢‡∏á (‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á) -->
              <div class="flex flex-col gap-3">
                <div class="flex flex-col gap-3 md:w-[360px] md:flex-shrink-0">
                  <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á -->
                  <div class="relative w-full">
                    <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ -->
                    <span
                      class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                    >
                      <!-- ‡∏´‡πâ‡∏≠‡∏á -->
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-4 h-4"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                      >
                        <path
                          d="M2 7.5A1.5 1.5 0 013.5 6h17A1.5 1.5 0 0122 7.5V18a1 1 0 01-1 1h-1v-3H4v3H3a1 1 0 01-1-1V7.5zM6 8a2 2 0 100 4h6a2 2 0 100-4H6z"
                        />
                      </svg>
                    </span>

                    <select
                      *ngIf="!isOther(i)"
                      class="w-full h-10 text-sm pl-9 pr-10 border border-gray-300 rounded-lg bg-white text-gray-700 appearance-none focus:outline-none focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF] transition-colors"
                      formControlName="type"
                      (change)="onTypeChange(i)"
                    >
                      <option value="" disabled selected>
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á
                      </option>
                      <option value="‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏î‡∏•‡∏°">‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏î‡∏•‡∏°</option>
                      <option value="‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏≠‡∏£‡πå">‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏≠‡∏£‡πå</option>
                      <option value="‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏î‡∏•‡∏° + ‡πÅ‡∏≠‡∏£‡πå">‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏î‡∏•‡∏° + ‡πÅ‡∏≠‡∏£‡πå</option>
                      <option value="other">
                        ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏≠‡∏£‡πå+‡∏û‡∏±‡∏î‡∏•‡∏°/‡∏ä‡∏±‡πâ‡∏ô 3)
                      </option>
                    </select>

                    <!-- Input field ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" -->
                    <input
                      *ngIf="isOther(i)"
                      type="text"
                      class="w-full h-10 text-sm pl-9 pr-4 border border-gray-300 rounded-lg bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF] transition-colors"
                      formControlName="customType"
                      placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏≠‡∏£‡πå+‡∏û‡∏±‡∏î‡∏•‡∏°/‡∏ä‡∏±‡πâ‡∏ô 3)"
                      (blur)="confirmOther(i)"
                    />

                    <!-- caret custom -->
                    <svg
                      *ngIf="!isOther(i)"
                      xmlns="http://www.w3.org/2000/svg"
                      class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19.5 8.25l-7.5 7.5-7.5-7.5"
                      />
                    </svg>
                  </div>

                  <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ï‡∏µ‡∏¢‡∏á -->
                  <div class="relative w-full">
                    <span
                      class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                    >
                      <!-- ‡πÄ‡∏ï‡∏µ‡∏¢‡∏á -->
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="w-4 h-4"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                      >
                        <path
                          d="M3 7a2 2 0 012-2h8a2 2 0 012 2v3h4a2 2 0 012 2v5h-2v-2H5v2H3V7z"
                        />
                      </svg>
                    </span>

                    <select
                      class="w-full h-10 text-sm pl-9 pr-10 border border-gray-300 rounded-lg bg-white text-gray-700 appearance-none focus:outline-none focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF] transition-colors"
                      formControlName="bed_type"
                    >
                      <option value="" disabled selected>
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ï‡∏µ‡∏¢‡∏á
                      </option>
                      <option value="‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß</option>
                      <option value="‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏Ñ‡∏π‡πà">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á‡∏Ñ‡∏π‡πà</option>
                    </select>

                    <!-- caret custom -->
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M19.5 8.25l-7.5 7.5-7.5-7.5"
                      />
                    </svg>
                  </div>
                </div>
              </div>

              <!-- ‡∏Ç‡∏ß‡∏≤: ‡πÅ‡∏ñ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‚Üí ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏° ‚Üí ‡∏£‡∏≤‡∏¢‡∏ã‡∏±‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå -->
              <div class="grid grid-cols-2 gap-3">
                <input
                  type="text"
                  inputmode="numeric"
                  pattern="^\\d+$"
                  (input)="enforceNumeric($event)"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-0 focus:border-[#007AFF] transition-colors"
                  [class.border-red-500]="roomType.get('pricePerDay')?.errors?.['min'] && roomType.get('pricePerDay')?.touched"
                  placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô"
                  formControlName="pricePerDay"
                />
                <input
                  type="text"
                  inputmode="numeric"
                  pattern="^\\d+$"
                  (input)="enforceNumeric($event)"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-0 focus:border-[#007AFF] transition-colors"
                  [class.border-red-500]="roomType.get('pricePerMonth')?.errors?.['min'] && roomType.get('pricePerMonth')?.touched"
                  placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
                  formControlName="pricePerMonth"
                />
                <input
                  type="text"
                  inputmode="numeric"
                  pattern="^\\d+$"
                  (input)="enforceNumeric($event)"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-0 focus:border-[#007AFF] transition-colors"
                  [class.border-red-500]="roomType.get('pricePerTerm')?.errors?.['min'] && roomType.get('pricePerTerm')?.touched"
                  placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                  formControlName="pricePerTerm"
                />
                <input
                  type="text"
                  inputmode="numeric"
                  pattern="^\\d+$"
                  (input)="enforceNumeric($event)"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-0 focus:border-[#007AFF] transition-colors"
                  [class.border-red-500]="roomType.get('pricePerSummer')?.errors?.['min'] && roomType.get('pricePerSummer')?.touched"
                  placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≤‡∏¢‡∏ã‡∏±‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                  formControlName="pricePerSummer"
                />
              </div>
            </div>
          </div>

          <div
            *ngIf="roomType.errors?.['needMonthOrDay'] && (roomType.touched || roomType.dirty)"
            class="text-red-500 text-sm mt-2"
          >
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡πà‡∏≠‡∏á: <b>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</b>
          </div>

          <!-- ‡πÅ‡∏™‡∏î‡∏á error ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö bed_type -->
          <div
            *ngIf="roomType.get('bed_type')?.errors?.['required'] && (roomType.get('bed_type')?.touched || roomType.get('bed_type')?.dirty)"
            class="text-red-500 text-sm mt-2"
          >
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ï‡∏µ‡∏¢‡∏á
          </div>

          <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤ 0 ‡∏ö‡∏≤‡∏ó -->
          <div *ngIf="hasZeroPriceError(roomType)" class="text-red-500 text-sm mt-2">
            <span>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>

        <div class="flex justify-center">
          <button
            id="add-room-type-btn"
            type="button"
            (click)="addRoomType()"
            class="px-5 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md font-medium transition"
          >
            + ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á
          </button>
        </div>
      </div>

      <!-- ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å -->
      <div formArrayName="amenities" class="mt-8">
        <h3
          id="amenities-header"
          class="text-xl font-semibold text-gray-800 mb-6 pb-3 border-b border-gray-200"
        >
          ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å
        </h3>
        <!-- ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏´‡∏°‡∏ß‡∏î: ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á -->
          <div>
            <h4 class="text-lg font-semibold text-gray-600 mb-4">‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <ng-container *ngFor="let a of amenitiesList; let i = index">
                <label
                  *ngIf="a.location_type === '‡∏†‡∏≤‡∏¢‡πÉ‡∏ô'"
                  class="flex items-center space-x-2 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    [formControlName]="i"
                    (change)="onAmenityChange(i, a.id)"
                    class="w-4 h-4 rounded border-gray-300 accent-red-500 focus:outline-none focus:ring-2 focus:ring-red-200"
                  />
                  <span
                    class="text-sm select-none"
                    [ngClass]="
                      dormForm.get('amenities')?.value[i]
                        ? 'text-gray-900 font-medium'
                        : 'text-gray-600'
                    "
                  >
                    {{ a.name }}
                  </span>
                </label>
              </ng-container>
            </div>
          </div>

          <!-- ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
          <div>
            <h4 class="text-lg font-semibold text-gray-600 mb-4">‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <ng-container *ngFor="let a of amenitiesList; let i = index">
                <label
                  *ngIf="a.location_type === '‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å'"
                  class="flex items-center space-x-2 cursor-pointer"
                >
                  <input
                    type="checkbox"
                    [formControlName]="i"
                    (change)="onAmenityChange(i, a.id)"
                    class="w-4 h-4 rounded border-gray-300 accent-red-500 focus:outline-none focus:ring-2 focus:ring-red-200"
                  />
                  <span
                    class="text-sm select-none"
                    [ngClass]="
                      dormForm.get('amenities')?.value[i]
                        ? 'text-gray-900 font-medium'
                        : 'text-gray-600'
                    "
                  >
                    {{ a.name }}
                  </span>
                </label>
              </ng-container>
            </div>
          </div>
        </div>
        <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' ‡πÇ‡∏ú‡∏•‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ -->
        <div *ngIf="isAmenityChecked('other')" class="mt-4 space-y-2">
          <div class="text-sm text-gray-700 font-medium">
            ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å (‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
          </div>
          <div
            *ngFor="let ctrl of amenitiesOther.controls; let k = index"
            formArrayName="amenitiesOther"
            class="flex items-center gap-2"
          >
            <div [formGroupName]="k" class="flex flex-col gap-2 flex-1">
              <input
                type="text"
                formControlName="name"
                maxlength="50"
                placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å"
                class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF]"
              />
              <select
                formControlName="location_type"
                class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF]"
              >
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                <option value="‡∏†‡∏≤‡∏¢‡πÉ‡∏ô">‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</option>
                <option value="‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å">‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</option>
                <option value="‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á">‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
              </select>
            </div>
            <button
              type="button"
              (click)="removeOtherAmenityField(k)"
              *ngIf="amenitiesOther.length > 1"
              class="px-2 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded"
            >
              ‡∏•‡∏ö
            </button>
          </div>
          <button
            type="button"
            (click)="addOtherAmenityField()"
            class="text-sm text-[#007AFF] hover:underline"
          >
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
          </button>
        </div>
      </div>

      <!-- ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ -->
      <div formGroupName="utilities">
        <h3
          class="text-xl font-semibold text-gray-800 mb-6 pb-3 border-b border-gray-200"
        >
          ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
        </h3>

        <!-- ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü -->
        <div formGroupName="electricity" class="mb-8">
          <div class="rounded-xl border border-gray-200 bg-white">
            <div
              class="px-5 py-3 border-b bg-gradient-to-r from-blue-50 to-white rounded-t-xl"
            >
              <h4 class="font-semibold text-gray-800">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</h4>
            </div>

            <div class="p-5 grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
              <!-- ‡∏ã‡πâ‡∏≤‡∏¢: Segmented control (‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü) -->
              <div class="space-y-2 flex flex-col justify-center">
                <div
                  class="grid grid-cols-2 rounded-lg border border-gray-200 bg-white overflow-hidden w-full"
                >
                  <!-- ‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢ -->
                  <button
                    type="button"
                    (click)="
                      electricity
                        .get('electricity_type')
                        ?.setValue('‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢')
                    "
                    [ngClass]="
                      electricity.get('electricity_type')?.value ===
                      '‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢'
                        ? 'bg-blue-500 text-white shadow-sm'
                        : 'bg-white text-gray-700 hover:bg-gray-50'
                    "
                    class="h-10 flex items-center justify-center px-4 text-sm font-medium tracking-wide transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
                  >
                    ‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢
                  </button>

                  <!-- ‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ -->
                  <button
                    type="button"
                    (click)="
                      electricity
                        .get('electricity_type')
                        ?.setValue('‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå')
                    "
                    [ngClass]="
                      electricity.get('electricity_type')?.value ===
                      '‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'
                        ? 'bg-blue-500 text-white shadow-sm'
                        : 'bg-white text-gray-700 hover:bg-gray-50'
                    "
                    class="h-10 flex items-center justify-center px-4 text-sm font-medium tracking-wide transition-colors border-l border-gray-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
                  >
                    ‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
                  </button>
                </div>
              </div>

              <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å/‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
              <div class="space-y-2 flex flex-col justify-center">
                <div
                  *ngIf="
                    electricity.get('electricity_type')?.value === '‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢'
                  "
                >
                  <div class="relative">
                    <span
                      class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                      >‡∏ø</span
                    >
                    <input
                      type="text"
                      formControlName="electricity_rate"
                      class="w-full h-10 pl-7 pr-20 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF] transition-colors"
                      [class.border-red-500]="(electricity.get('electricity_rate')?.errors?.['min'] || electricity.get('electricity_rate')?.errors?.['required']) && electricity.get('electricity_rate')?.touched"
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô 8.00"
                      pattern="^\\d+(\\.\\d{1,2})?$"
                      (input)="enforceNumeric($event); electricity.get('electricity_rate')?.updateValueAndValidity()"
                    />
                    <span
                      class="absolute right-2 top-1/2 -translate-y-1/2 text-[11px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 border border-blue-100"
                    >
                      ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢
                    </span>
                  </div>
                  <div *ngIf="electricity.get('electricity_rate')?.invalid && electricity.get('electricity_rate')?.touched" class="text-red-500 text-xs mt-1">
                    <span *ngIf="electricity.get('electricity_rate')?.errors?.['min']">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡∏ö‡∏≤‡∏ó</span>
                    <span *ngIf="electricity.get('electricity_rate')?.errors?.['required']">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</span>
                  </div>
                </div>

                <div
                  *ngIf="
                    electricity.get('electricity_type')?.value === '‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'
                  "
                >
                  <div
                    class="w-full h-10 px-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-600 flex items-center"
                  >
                    ‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ (‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥ -->
        <div formGroupName="water">
          <div class="rounded-xl border border-gray-200 bg-white">
            <div
              class="px-5 py-3 border-b bg-gradient-to-r from-blue-50 to-white rounded-t-xl"
            >
              <h4 class="font-semibold text-gray-800">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥</h4>
            </div>

            <div class="p-5 grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
              <!-- ‡∏ã‡πâ‡∏≤‡∏¢: Segmented control (‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥) -->
              <div class="space-y-2 flex flex-col justify-center">
                <div
                  class="grid grid-cols-3 rounded-lg border border-gray-200 bg-white overflow-hidden w-full"
                >
                  <!-- ‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢ -->
                  <button
                    type="button"
                    (click)="water.get('water_type')?.setValue('‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢')"
                    [ngClass]="
                      water.get('water_type')?.value === '‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢'
                        ? 'bg-blue-500 text-white shadow-sm'
                        : 'bg-white text-gray-700 hover:bg-gray-50'
                    "
                    class="h-10 flex items-center justify-center px-4 text-sm font-mediumtracking-wide transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
                  >
                    ‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢
                  </button>

                  <!-- ‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢ -->
                  <button
                    type="button"
                    (click)="water.get('water_type')?.setValue('‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢')"
                    [ngClass]="
                      water.get('water_type')?.value === '‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢'
                        ? 'bg-blue-500 text-white shadow-sm'
                        : 'bg-white text-gray-700 hover:bg-gray-50'
                    "
                    class="h-10 flex items-center justify-center px-4 text-sm font-medium tracking-wide transition-colors border-l border-gray-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
                  >
                    ‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢
                  </button>

                  <!-- ‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
                  <button
                    type="button"
                    (click)="water.get('water_type')?.setValue('‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå')"
                    [ngClass]="
                      water.get('water_type')?.value === '‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'
                        ? 'bg-blue-500 text-white shadow-sm'
                        : 'bg-white text-gray-700 hover:bg-gray-50'
                    "
                    class="h-10 flex items-center justify-center px-4 text-sm font-medium tracking-wide transition-colors border-l border-gray-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400"
                  >
                    ‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
                  </button>
                </div>
              </div>

              <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å/‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
              <div class="space-y-2 flex flex-col justify-center">
                <div
                  *ngIf="
                    water.get('water_type')?.value === '‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢' ||
                    water.get('water_type')?.value === '‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢'
                  "
                >
                  <div class="relative">
                    <span
                      class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                      >‡∏ø</span
                    >
                    <input
                      type="text"
                      formControlName="water_rate"
                      class="w-full h-10 pl-7 pr-24 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#007AFF] focus:border-[#007AFF] transition-colors"
                      [class.border-red-500]="(water.get('water_rate')?.errors?.['min'] || water.get('water_rate')?.errors?.['required']) && water.get('water_rate')?.touched"
                      [placeholder]="
                        water.get('water_type')?.value === '‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢'
                          ? '‡πÄ‡∏ä‡πà‡∏ô 200'
                          : '‡πÄ‡∏ä‡πà‡∏ô 18.50'
                      "
                      pattern="^\\d+(\\.\\d{1,2})?$"
                      (input)="enforceNumeric($event); water.get('water_rate')?.updateValueAndValidity()"
                    />
                    <span
                      class="absolute right-2 top-1/2 -translate-y-1/2 text-[11px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 border border-blue-100"
                      >{{
                        water.get("water_type")?.value === "‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢"
                          ? "‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
                          : "‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢"
                      }}</span
                    >
                  </div>
                  <div *ngIf="water.get('water_rate')?.invalid && water.get('water_rate')?.touched" class="text-red-500 text-xs mt-1">
                    <span *ngIf="water.get('water_rate')?.errors?.['min']">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡∏ö‡∏≤‡∏ó</span>
                    <span *ngIf="water.get('water_rate')?.errors?.['required']">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥</span>
                  </div>
                </div>

                <div *ngIf="water.get('water_type')?.value === '‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'">
                  <div
                    class="w-full h-10 px-4 border border-gray-200 rounded-lg bg-gray-50 text-gray-600 flex items-center"
                  >
                    ‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ (‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏õ‡∏≤)
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å -->
      <div formGroupName="location">
        <h3
          class="text-xl font-semibold text-gray-800 mb-6 pb-3 border-b border-gray-200"
        >
          ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å
        </h3>
        <div
          class="w-full h-[500px] rounded-lg overflow-hidden border border-gray-200 mb-4 relative"
          style="min-height: 500px; position: relative; z-index: 1"
        >
          <div
            id="location-map"
            class="w-full h-full"
            style="min-height: 500px; position: relative; z-index: 1"
          ></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-700"
              >‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î</label
            >
            <input
              type="text"
              formControlName="latitude"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
          </div>
          <div>
            <label class="block mb-2 text-sm font-medium text-gray-700"
              >‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î</label
            >
            <input
              type="text"
              formControlName="longitude"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50"
              readonly
            />
          </div>
        </div>
      </div>

      <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏≠‡∏û‡∏±‡∏Å -->
      <div>
        <h3
          class="text-xl font-semibold text-gray-800 mb-6 pb-3 border-b border-gray-200"
        >
          ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏≠‡∏û‡∏±‡∏Å
        </h3>

        <div class="flex flex-col items-center text-center mb-4">
          <div class="text-gray-600">
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏≠‡∏û‡∏±‡∏Å
            <span class="text-gray-500"
              >(‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ <span class="text-red-500">5</span> ‡∏†‡∏≤‡∏û)</span
            >
            <div class="text-xs text-blue-600 mt-1">
              ‡∏†‡∏≤‡∏û‡πÅ‡∏£‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å
            </div>
          </div>
        </div>

        <div class="mb-4">
          <!-- Drag & Drop Zone -->
          <div
            class="upload-dropzone"
            [class.drag-over]="isDragOver"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            (click)="triggerFileInput()"
          >
            <input
              type="file"
              #fileInput
              id="file-upload"
              class="hidden"
              accept="image/*"
              multiple
              (change)="onFileSelect($event)"
            />
            <div class="upload-content">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                class="w-12 h-12 text-gray-400 mb-3"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 5.25A2.25 2.25 0 015.25 3h13.5A2.25 2.25 0 0121 5.25v13.5A2.25 2.25 0 0118.75 21H5.25A2.25 2.25 0 013 18.75V5.25z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 15l4.5-4.5a2.121 2.121 0 013 0L15 15m0 0l2.25-2.25a2.121 2.121 0 013 0L21 13.5"
                />
              </svg>
              <div class="text-gray-600 text-center">
                <div class="font-medium mb-1">
                  <span *ngIf="!isDragOver"></span>
                  <span *ngIf="isDragOver" class="text-blue-600"></span>
                </div>
                <div class="text-sm text-gray-500"></div>
                <div class="text-xs text-gray-400 mt-2">
                  ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, GIF (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB ‡∏ï‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="imageError" class="text-red-500 text-sm mt-2">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 5 ‡∏†‡∏≤‡∏û
          </div>
        </div>

        <!-- Image Gallery with Drag & Drop Reordering -->
        <div
          class="edit-image-gallery relative"
          *ngIf="imagePreviewUrls.length > 0"
          cdkDropList
          (cdkDropListDropped)="onImageReorder($event)"
        >
          <!-- Overlay while setting primary or deleting -->
          <div *ngIf="isSettingPrimary || isDeletingImage" class="absolute inset-0 z-10 bg-white/60 flex items-center justify-center rounded-lg">
            <span class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></span>
          </div>
          <div
            *ngFor="let image of imagePreviewUrls; let i = index"
            class="relative group"
            [class.main-image]="i === 0"
            [class.dragging]="draggedIndex === i"
            cdkDrag
            [cdkDragData]="i"
          >
            <!-- Image Container -->
            <div
              class="relative h-32 w-32 rounded-lg overflow-hidden border-2 transition-all duration-200"
              [class.border-blue-500]="i === 0"
              [class.border-gray-300]="i !== 0"
              [class.shadow-lg]="i === 0"
              [class.shadow-md]="i !== 0"
            >
              <!-- Main Image Badge -->
              <div
                *ngIf="i === 0"
                class="absolute top-1 left-1 bg-gradient-to-r from-yellow-400 to-yellow-500 text-white text-xs px-2 py-1 rounded-full font-medium z-10 shadow-md flex items-center space-x-1"
              >
                <i class="fas fa-star text-xs"></i>
                <span>‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å</span>
              </div>

              <!-- Drag Handle -->
              <div
                class="absolute top-1 right-1 bg-black bg-opacity-50 text-white p-1 rounded cursor-move opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10"
                cdkDragHandle
              >
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
                  />
                </svg>
              </div>

              <!-- Image -->
              <img [src]="image" class="w-full h-full object-cover" />

              <!-- Overlay on hover -->
              <div
                class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all duration-200 flex flex-col items-center justify-center space-y-1"
              >
                <!-- Set as main image button (only show if not already main) -->
                <button
                  *ngIf="!isMainImage(i)"
                  type="button"
                  (click)="setAsMainImage(i)"
                  class="bg-blue-500 text-white px-2 py-1 rounded text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-blue-600 flex items-center space-x-1"
                >
                  <i class="fas fa-star text-xs" *ngIf="!(isSettingPrimary && settingPrimaryIndex===i)"></i>
                  <span *ngIf="!(isSettingPrimary && settingPrimaryIndex===i)">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å</span>
                  <span *ngIf="isSettingPrimary && settingPrimaryIndex===i" class="inline-block w-3.5 h-3.5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                </button>
                
                <!-- Remove button -->
                <button
                  type="button"
                  (click)="removeImage(i)"
                  [disabled]="isDeletingImage"
                  class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-red-600 disabled:opacity-50"
                >
                  <span *ngIf="!isDeletingImage || deletingImageIndex !== i">√ó</span>
                  <span *ngIf="isDeletingImage && deletingImageIndex === i" class="inline-block w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                </button>
              </div>

              <!-- Order Number -->
              <div
                class="absolute bottom-1 right-1 bg-black bg-opacity-70 text-white text-xs px-1.5 py-0.5 rounded"
              >
                {{ i + 1 }}
              </div>
            </div>

            <!-- Instructions for main image -->
            <div
              *ngIf="i === 0"
              class="text-xs text-blue-600 mt-1 text-center"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <!-- ==================== /Step 1 ==================== -->

    <!-- ==================== Step 2 ==================== -->
    <div *ngIf="currentStep === 2">
      <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á + ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢/‡∏Ç‡∏ß‡∏≤ -->
      <div class="mb-6">
        <div class="center-carousel">
          <div class="carousel-viewport select-none">
            <!-- Prev faded -->
            <img
              *ngIf="hasImages"
              [src]="imagePreviewUrls[prevImageIndex]"
              alt="prev"
              class="carousel-side carousel-left"
            />
            <!-- Current -->
            <img
              *ngIf="hasImages"
              [src]="imagePreviewUrls[currentImageIndex]"
              alt="current"
              class="carousel-current"
              [@slideCenter]="currentImageIndex"
              (click)="openImageModal(currentImageIndex)"
            />
            <!-- Next faded -->
            <img
              *ngIf="hasImages"
              [src]="imagePreviewUrls[nextImageIndex]"
              alt="next"
              class="carousel-side carousel-right"
            />
            <!-- Controls -->
            <button
              type="button"
              class="carousel-btn left"
              (click)="onPrevImage()"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                class="w-6 h-6"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
            </button>
            <button
              type="button"
              class="carousel-btn right"
              (click)="onNextImage()"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                class="w-6 h-6"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏Å‡∏£‡∏≠‡∏ö/‡πÄ‡∏á‡∏≤) -->
      <div class="mb-8">
        <div class="p-0">
          <div class="flex items-start justify-between gap-6">
            <div class="min-w-0 flex-1">
              <div class="flex items-center justify-between gap-2">
                <h2
                  class="text-2xl font-bold text-gray-900 leading-tight truncate"
                >
                  {{ dormForm.get("generalInfo.name")?.value || "‚Äî" }}
                </h2>
                <span *ngIf="isEditMode && dormForm.get('generalInfo.statusDorm')?.value" 
                      [ngClass]="{
                        'bg-green-100 text-green-700 border-green-300': dormForm.get('generalInfo.statusDorm')?.value === '‡∏ß‡πà‡∏≤‡∏á',
                        'bg-red-100 text-red-700 border-red-300': dormForm.get('generalInfo.statusDorm')?.value === '‡πÄ‡∏ï‡πá‡∏°'
                      }"
                      class="px-3 py-1 rounded-full text-xs font-semibold border whitespace-nowrap">
                  {{ dormForm.get('generalInfo.statusDorm')?.value }}
                </span>
              </div>
              <div class="flex items-start text-gray-600 mt-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5 mr-2 text-blue-500 -mt-[0.5px]"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <span class="leading-snug break-words">{{
                  dormForm.get("generalInfo.address")?.value || "‚Äî"
                }}</span>
              </div>
              <div class="mt-2 text-gray-700">
                <span
                  class="inline-flex items-center px-2 py-0.5 rounded-md bg-blue-50 text-blue-700 text-sm"
                  >‡πÇ‡∏ã‡∏ô: {{ zoneName || "‚Äî" }}</span
                >
              </div>
            </div>
            <div class="text-right shrink-0">
              <div class="text-2xl font-extrabold text-gray-900">
                {{ priceRangeText }}
              </div>
              <!-- <div class="text-xs text-gray-500">‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div> -->
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="px-0 py-0">
              <div class="text-sm font-semibold text-gray-700">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥</div>
              
              <div class="mt-1 text-gray-600 leading-relaxed">
                <ng-container [ngSwitch]="water.value.water_type">
                  <span *ngSwitchCase="'‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢'"
                    >‡πÄ‡∏´‡∏°‡∏≤‡∏à‡πà‡∏≤‡∏¢:
                    {{ water.value.water_rate || "-" }} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span
                  >
                  <span *ngSwitchCase="'‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢'"
                    >{{ water.value.water_rate || "-" }} ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢</span
                  >
                  <span *ngSwitchDefault>‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</span>
                </ng-container>
              </div>
            </div>
            <div class="px-0 py-0">
              <div class="text-sm font-semibold text-gray-700">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</div>
              <div class="mt-1 text-gray-600 leading-relaxed">
                <ng-container [ngSwitch]="electricity.value.electricity_type">
                  <span *ngSwitchCase="'‡∏Ñ‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢'"
                    >{{
                      electricity.value.electricity_rate || "-"
                    }}
                    ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢</span
                  >
                  <span *ngSwitchCase="'‡∏ï‡∏≤‡∏°‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'">‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</span>
                  <span *ngSwitchDefault>‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</span>
                </ng-container>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">
              ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏≠‡∏û‡∏±‡∏Å
            </h3>
            <p class="text-gray-600 leading-relaxed">
              {{ dormForm.get("generalInfo.description")?.value || "‚Äî" }}
            </p>
          </div>
        </div>
      </div>

      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-gray-50 font-bold leading-relaxed">
                <th class="py-3 px-4 text-left font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                <th class="py-3 px-4 text-right font-medium">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th>
                <th class="py-3 px-4 text-right font-medium">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</th>
                <th class="py-3 px-4 text-right font-medium">‡∏£‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏°</th>
                <th class="py-3 px-4 text-right font-medium">‡∏£‡∏≤‡∏¢‡∏ã‡∏±‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <tr
                *ngFor="let rt of roomTypes.value; let i = index"
                class="hover:bg-gray-50"
              >
                <td class="py-3 px-4 text-gray-600 leading-relaxed">
                  {{ getRoomDisplayName(rt) }}
                </td>
                <td class="py-3 px-4 text-right text-gray-600 leading-relaxed">
                  {{ formatNumberOrDash(rt.pricePerMonth) }}
                </td>
                <td class="py-3 px-4 text-right text-gray-600 leading-relaxed">
                  {{ formatNumberOrDash(rt.pricePerDay) }}
                </td>
                <td class="py-3 px-4 text-right text-gray-600 leading-relaxed">
                  {{ formatNumberOrDash(rt.pricePerTerm) }}
                </td>
                <td class="py-3 px-4 text-right text-gray-600 leading-relaxed">
                  {{ formatNumberOrDash(rt.pricePerSummer) }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <h3 class="text-lg font-semibold text-gray-800 mb-3">
          ‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å
        </h3>
        <!-- ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏´‡∏°‡∏ß‡∏î: ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á -->
          <div>
            <h4 class="text-lg font-semibold text-gray-600 mb-4">‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á</h4>
            <div class="space-y-3">
              <ng-container *ngFor="let amenity of amenitiesList">
                <div
                  *ngIf="amenity.location_type === '‡∏†‡∏≤‡∏¢‡πÉ‡∏ô'"
                  class="flex items-center"
                >
                  <span
                    class="text-sm flex items-center"
                    [ngClass]="
                      dormForm.get('amenities')?.value[
                        getAmenityIndex(amenity.id)
                      ]
                        ? 'text-gray-700'
                        : 'text-gray-400 line-through'
                    "
                  >
                    <!-- FontAwesome Icons -->
                    <i
                      *ngIf="amenity.id === 'dressingTable'"
                      class="fas fa-magic mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'aircon'"
                      class="fas fa-snowflake mr-2"
                    ></i>
                    <i *ngIf="amenity.id === 'fan'" class="fas fa-fan mr-2"></i>
                    <i *ngIf="amenity.id === 'tv'" class="fas fa-tv mr-2"></i>
                    <i
                      *ngIf="amenity.id === 'fridge'"
                      class="fas fa-box mr-2"
                    ></i>
                    <i *ngIf="amenity.id === 'bed'" class="fas fa-bed mr-2"></i>
                    <i
                      *ngIf="amenity.id === 'wifi'"
                      class="fas fa-wifi mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'wardrobe'"
                      class="fas fa-door-open mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'desk'"
                      class="fas fa-desktop mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'microwave'"
                      class="fas fa-microchip mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'waterHeater'"
                      class="fas fa-hot-tub mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'sink'"
                      class="fas fa-tint mr-2"
                    ></i>

                    {{ amenity.name }}
                  </span>
                </div>
              </ng-container>
            </div>
          </div>

          <!-- ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
          <div>
            <h4 class="text-lg font-semibold text-gray-600 mb-4">‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</h4>
            <div class="space-y-3">
              <ng-container *ngFor="let amenity of amenitiesList">
                <div
                  *ngIf="amenity.location_type === '‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å'"
                  class="flex items-center"
                >
                  <span
                    class="text-sm flex items-center"
                    [ngClass]="
                      dormForm.get('amenities')?.value[
                        getAmenityIndex(amenity.id)
                      ]
                        ? 'text-gray-700'
                        : 'text-gray-400 line-through'
                    "
                  >
                    <!-- External amenities -->
                    <i
                      *ngIf="amenity.id === 'cctv'"
                      class="fas fa-video mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'security'"
                      class="fas fa-shield-alt mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'elevator'"
                      class="fas fa-arrow-up mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'parking'"
                      class="fas fa-car mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'fitness'"
                      class="fas fa-dumbbell mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'lobby'"
                      class="fas fa-building mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'waterDispenser'"
                      class="fas fa-tint mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'swimmingPool'"
                      class="fas fa-swimming-pool mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'parcelShelf'"
                      class="fas fa-box mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'petsAllowed'"
                      class="fas fa-paw mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'keyCard'"
                      class="fas fa-key mr-2"
                    ></i>
                    <i
                      *ngIf="amenity.id === 'washingMachine'"
                      class="fas fa-tshirt mr-2"
                    ></i>

                    {{ amenity.name }}
                  </span>
                </div>
              </ng-container>
            </div>
          </div>
        </div>

        <div
          *ngIf="isAmenityChecked('other') && amenitiesOther.length"
          class="mt-4"
        >
          <div class="text-sm text-gray-600 mb-1">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
          <ul class="list-disc list-inside text-sm text-gray-800">
            <li *ngFor="let ctrl of amenitiesOther.controls">
              {{ ctrl.get("name")?.value }}
              <span class="text-xs text-gray-500"
                >({{ ctrl.get("location_type")?.value || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏" }})</span
              >
            </li>
          </ul>
        </div>

        <!-- 6. ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà) -->
        <div class="mb-8 mt-8">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å</h3>
          <div
            class="w-full h-96 rounded-lg overflow-hidden border border-gray-300 mb-4"
          >
            <div id="preview-map" class="w-full h-full"></div>
          </div>
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="grid grid-cols-2 gap-6">
              <div>
                <div class="text-xs text-gray-500 font-medium mb-1">
                  ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î
                </div>
                <div class="text-sm font-semibold text-gray-800">
                  {{ dormForm.get("location.latitude")?.value || "‚Äî" }}
                </div>
              </div>
              <div>
                <div class="text-xs text-gray-500 font-medium mb-1">
                  ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î
                </div>
                <div class="text-sm font-semibold text-gray-800">
                  {{ dormForm.get("location.longitude")?.value || "‚Äî" }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- /card -->
    </div>

    <!-- Image Fullscreen Modal -->
    <div *ngIf="imageModalOpen" class="fixed inset-0 z-50">
      <div
        class="absolute inset-0 bg-black/70"
        (click)="closeImageModal()"
      ></div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <button
          type="button"
          (click)="closeImageModal()"
          class="absolute top-4 right-4 text-white p-3"
        >
          <span class="material-symbols-rounded text-3xl">close</span>
        </button>

        <!-- Prev -->
        <button
          type="button"
          (click)="prevModalImage()"
          class="absolute left-6 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white p-3 shadow"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            />
          </svg>
        </button>

        <!-- Next -->
        <button
          type="button"
          (click)="nextModalImage()"
          class="absolute right-6 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white p-3 shadow"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </button>

        <img
          [src]="imagePreviewUrls[imageModalIndex]"
          [alt]="'‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏≠‡∏û‡∏±‡∏Å ' + (imageModalIndex + 1)"
          class="max-h-[85vh] max-w-[92vw] object-contain select-none"
        />
      </div>
    </div>
    <!-- ==================== /Step 2 ==================== -->

    <!-- ==================== Step 3 ==================== -->
    <div *ngIf="currentStep === 3" class="text-center py-16">
      <div
        class="w-24 h-24 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center"
      >
        <svg
          class="w-12 h-12 text-green-500"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 13l4 4L19 7"
          ></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-4">
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
      </h2>
      <p class="text-gray-600 mb-8">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1-2 ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£
      </p>
      <button
        type="button"
        class="px-8 py-3 bg-[#007AFF] hover:bg-[#0056CC] text-white rounded-lg font-medium transition-colors min-w-[120px]"
        (click)="goToOwnerPage()"
      >
        ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Owner
      </button>
    </div>
    <!-- ==================== /Step 3 ==================== -->

    <!-- Navigation -->
    <div
      *ngIf="currentStep < 3"
      class="flex justify-center gap-4 mt-12 pt-8 border-t border-gray-200"
    >
      <button
        type="button"
        class="px-8 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-colors min-w-[120px] disabled:opacity-60 disabled:cursor-not-allowed"
        (click)="cancelForm()"
        [disabled]="isSubmitting"
      >
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
      <button
        type="button"
        *ngIf="currentStep > 1"
        (click)="prevStep()"
        class="px-8 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors min-w-[120px] disabled:opacity-60 disabled:cursor-not-allowed"
        [disabled]="isSubmitting"
      >
        ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
      </button>
      <button
        type="button"
        *ngIf="currentStep < 2"
        (click)="nextStep()"
        class="px-8 py-3 bg-[#007AFF] hover:bg-[#0056CC] text-white rounded-lg font-medium transition-colors min-w-[120px] disabled:opacity-60 disabled:cursor-not-allowed"
        [disabled]="isSubmitting"
      >
        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      </button>
      <button
        type="button"
        *ngIf="currentStep === 2"
        (click)="onSubmit()"
        class="px-8 py-3 bg-[#007AFF] hover:bg-[#0056CC] text-white rounded-lg font-medium transition-colors min-w-[120px] disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center"
        [disabled]="isSubmitting"
      >
        <span
          *ngIf="isSubmitting"
          class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"
        ></span>
        <span *ngIf="!isSubmitting">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
        <span *ngIf="isSubmitting">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
      </button>
    </div>
  </div>
</form>

<!-- Initial loading overlay -->
<div *ngIf="isInitialLoading" class="fixed inset-0 z-40 flex items-center justify-center bg-white/70">
  <div class="flex flex-col items-center">
    <span class="inline-block w-10 h-10 border-4 border-[#007AFF] border-t-transparent rounded-full animate-spin"></span>
    <div class="mt-3 text-sm font-semibold text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°...</div>
  </div>
  </div>

<!-- Elegant Popup Modal -->
<div
  *ngIf="showPopup"
  class="fixed inset-0 z-50 flex items-center justify-center p-4"
>
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
  <div
    class="relative bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden"
  >
    <!-- top decoration bar (red for error, blue for others) -->
    <div
      class="h-2 w-full"
      [class]="popupType === 'error' ? 'bg-red-500' : 'bg-[#007AFF]'"
    ></div>

    <!-- header -->
    <button
      (click)="closePopup(false)"
      class="absolute right-3 top-3 w-9 h-9 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition"
    >
      <span class="material-symbols-rounded text-gray-600">close</span>
    </button>

    <div class="px-8 pt-10 pb-4 text-center">
      <div
        class="mx-auto w-20 h-20 rounded-full shadow-md grid place-items-center mb-4"
        [class]="
          popupType === 'error'
            ? 'bg-red-50 text-red-500'
            : popupType === 'warning'
            ? 'bg-yellow-50 text-yellow-600'
            : 'bg-green-50 text-green-600'
        "
      >
        <span class="material-symbols-rounded text-4xl" *ngIf="popupType === 'error'">error</span>
        <span class="material-symbols-rounded text-4xl" *ngIf="popupType === 'warning'">warning</span>
        <span class="material-symbols-rounded text-4xl" *ngIf="popupType === 'success'">check_circle</span>
      </div>
      <div class="text-2xl font-bold text-gray-900 mb-1">
        <span *ngIf="popupType === 'error'">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>
        <span *ngIf="popupType === 'warning'">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
        <span *ngIf="popupType === 'success'">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
      </div>
      <div class="text-gray-600 leading-relaxed whitespace-pre-line">
        {{ popupMessage }}
      </div>
    </div>

    <div class="px-8 pb-8">
      <button
        (click)="closePopup(true)"
        class="w-full py-3 rounded-full text-white font-semibold transition"
        [class]="
          popupType === 'error'
            ? 'bg-red-500 hover:bg-red-600'
            : 'bg-[#007AFF] hover:bg-[#005FD1]'
        "
      >
        ‡∏ï‡∏Å‡∏•‡∏á
      </button>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div
  *ngIf="showErrorModal"
  class="fixed inset-0 z-50 flex items-center justify-center"
>
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="relative bg-white rounded-xl shadow-xl w-full max-w-md p-6">
    <div class="flex items-start gap-3">
      <div
        class="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center shrink-0"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          class="w-6 h-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
      </div>
      <div class="flex-1">
        <h3 class="text-lg font-semibold text-gray-800 mb-1">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        </h3>
        <p class="text-gray-600">{{ submitErrorMessage }}</p>
      </div>
    </div>
    <div class="mt-6 flex justify-end gap-3">
      <button
        (click)="closeErrorModal()"
        class="px-5 py-2 bg-gray-200 hover:bg-gray-300 rounded-md"
      >
        ‡∏õ‡∏¥‡∏î
      </button>
    </div>
  </div>
</div>
