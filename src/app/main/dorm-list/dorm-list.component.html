<app-navbar></app-navbar>

<div class="w-full max-w-7xl mx-auto px-3 sm:px-4 pb-8 sm:pb-12 font-thai font-english pt-4 sm:pt-8">

<!-- Search filters section -->
<div class="bg-white shadow-md sm:shadow-lg rounded-lg p-3 sm:p-6 mb-4 sm:mb-6">
  <div class="flex flex-col gap-2.5 sm:gap-3">
    <!-- Search input - Full width on all screens -->
    <div class="w-full relative">
      <input 
        type="text" 
        [(ngModel)]="searchQuery"
        (input)="onSearchInput($event)"
        (keyup.enter)="onSearchSubmit()"
        class="w-full h-9 sm:h-10 px-3 sm:px-4 pr-10 sm:pr-12 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-0 focus:border-gray-300 font-thai"
        placeholder="ค้นหาหอพัก...">
      <button 
        (click)="onSearchSubmit()"
        class="absolute right-2 sm:right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </button>
      
      <!-- Clear search button -->
      <div 
        *ngIf="searchQuery" 
        class="search-badge absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg z-50 mt-1 p-2 sm:p-3">
        <div class="flex justify-between items-center gap-2">
          <span class="font-thai text-xs sm:text-sm text-gray-600 truncate">
            ผลลัพธ์: "{{ searchQuery }}"
          </span>
          <button 
            (click)="clearSearch()"
            class="px-2 sm:px-3 py-1 bg-gray-100 text-gray-600 rounded text-xs sm:text-sm font-thai hover:bg-gray-200 transition-colors whitespace-nowrap flex-shrink-0">
            ล้าง
          </button>
        </div>
      </div>
    </div>

    <!-- Zone, Sort, and Filter Group - Side by side on mobile -->
    <div class="flex gap-2 sm:gap-3 items-center w-full">
      <!-- Zone filter -->
      <div class="flex-1">
        <select 
          class="w-full h-9 sm:h-10 px-2.5 sm:px-3 pr-7 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-0 focus:border-gray-300 transition-colors font-thai appearance-none bg-white"
          style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 4 5\'><path fill=\'%23666\' d=\'M2 0L0 2h4zm0 5L0 3h4z\'/></svg>'); background-repeat: no-repeat; background-position: right 8px center; background-size: 10px;"
          [(ngModel)]="selectedZone" 
          (change)="filterByZone(selectedZone)">
          <option value="" [selected]="selectedZone === ''">โซน</option>
          <option *ngFor="let zone of zones" [value]="zone.zone_name" [selected]="selectedZone === zone.zone_name">{{ zone.zone_name }}</option>
        </select>
      </div>

      <!-- Sort price -->
      <div class="flex-1">
        <select 
          class="w-full h-9 sm:h-10 px-2.5 sm:px-3 pr-7 text-sm sm:text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-0 focus:border-gray-300 transition-colors font-thai appearance-none bg-white"
          style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 4 5\'><path fill=\'%23666\' d=\'M2 0L0 2h4zm0 5L0 3h4z\'/></svg>'); background-repeat: no-repeat; background-position: right 8px center; background-size: 10px;"
          [(ngModel)]="sortOrder" 
          (change)="applySelectedSort()">
          <option value="" disabled selected>ช่วงราคา</option>
          <option value="asc">ต่ำ-สูง</option>
          <option value="desc">สูง-ต่ำ</option>
        </select>
      </div>

      <!-- Filter button -->
      <div class="relative flex-shrink-0">
        <button 
          type="button"
          class="filter-button w-9 h-9 sm:w-10 sm:h-10 flex items-center justify-center rounded-lg focus:outline-none focus:ring-0 focus:border-gray-300 transition-colors"
          [ngClass]="{
            'filter-button-active': showFilterPopup,
            'filter-button-inactive': !showFilterPopup
          }"
          (click)="toggleFilterPopup($event)">
          <svg class="w-5 h-5 sm:w-5 sm:h-5" [class.text-yellow-600]="showFilterPopup" [class.text-gray-600]="!showFilterPopup" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
          </svg>
        </button>

        <!-- Mobile backdrop -->
        <div 
          *ngIf="showFilterPopup"
          class="fixed inset-0 bg-black bg-opacity-50 z-40 sm:hidden"
          (click)="showFilterPopup = false"></div>

        <!-- Filter popup - Mobile optimized -->
        <div 
          *ngIf="showFilterPopup"
          class="filter-popup-mobile fixed sm:absolute inset-x-0 sm:inset-x-auto bottom-0 sm:bottom-auto sm:top-full sm:right-0 w-full sm:w-[500px] bg-white border-t sm:border border-gray-200 sm:rounded-lg rounded-t-2xl sm:rounded-t-lg shadow-2xl sm:shadow-xl z-50 sm:mt-2 max-h-[85vh] sm:max-h-[80vh] overflow-hidden flex flex-col">
          <!-- Drag handle for mobile -->
          <div class="sm:hidden flex justify-center py-2 border-b border-gray-200">
            <div class="w-12 h-1 bg-gray-300 rounded-full"></div>
          </div>

          <!-- Title for mobile -->
          <div class="sm:hidden px-4 py-3 border-b border-gray-200">
            <h3 class="text-base font-medium text-gray-900 font-thai">ตัวกรอง</h3>
          </div>
          
          <div class="filter-popup-scroll p-4 sm:p-6 flex-1 overflow-y-auto">
            <div class="space-y-4 sm:space-y-6">
              <!-- ประเภทการเช่า -->
              <div>
                <h4 class="font-medium text-gray-900 mb-2 sm:mb-3 font-thai text-sm sm:text-base">ประเภทการเช่า</h4>
                <div class="flex gap-4 sm:gap-6">
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" [(ngModel)]="filters.daily" (change)="applyRentTypeFilter()" class="mr-2 w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500">
                    <span class="font-thai text-sm sm:text-base">รายวัน</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" [(ngModel)]="filters.monthly" (change)="applyRentTypeFilter()" class="mr-2 w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500">
                    <span class="font-thai text-sm sm:text-base">รายเดือน</span>
                  </label>
                </div>
              </div>

              <!-- คะแนน -->
              <!-- <div>
                <h4 class="font-medium text-gray-900 mb-2 sm:mb-3 font-thai text-sm sm:text-base">คะแนน</h4>
                <div class="flex flex-wrap gap-2 sm:gap-3">
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" [(ngModel)]="filters.rating5" (change)="applyRatingFilter()" class="mr-1.5 sm:mr-2 w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500">
                    <span class="font-thai text-xs sm:text-sm">5 ดาว</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" [(ngModel)]="filters.rating4" (change)="applyRatingFilter()" class="mr-1.5 sm:mr-2 w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500">
                    <span class="font-thai text-xs sm:text-sm">4 ดาว</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" [(ngModel)]="filters.rating3" (change)="applyRatingFilter()" class="mr-1.5 sm:mr-2 w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500">
                    <span class="font-thai text-xs sm:text-sm">3 ดาว</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" [(ngModel)]="filters.rating2" (change)="applyRatingFilter()" class="mr-1.5 sm:mr-2 w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500">
                    <span class="font-thai text-xs sm:text-sm">2 ดาว</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" [(ngModel)]="filters.rating1" (change)="applyRatingFilter()" class="mr-1.5 sm:mr-2 w-4 h-4 text-red-500 border-gray-300 rounded focus:ring-red-500">
                    <span class="font-thai text-xs sm:text-sm">1 ดาว</span>
                  </label>
                </div>
              </div> -->

              <!-- ช่วงราคา -->
              <div>
                <h4 class="font-medium text-gray-900 mb-2 sm:mb-3 font-thai text-sm sm:text-base">ช่วงราคา (บาท/เดือน)</h4>
                <div class="flex gap-2 sm:gap-3">
                  <input 
                    type="number" 
                    [(ngModel)]="filterMinPrice"
                    placeholder="ต่ำสุด" 
                    min="0"
                    class="flex-1 px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-thai">
                  <input 
                    type="number" 
                    [(ngModel)]="filterMaxPrice"
                    placeholder="สูงสุด" 
                    min="0"
                    class="flex-1 px-2 sm:px-3 py-1.5 sm:py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-thai">
                </div>
                <div class="text-xs text-gray-500 mt-1 font-thai hidden sm:block">
                  ตัวอย่าง: 3000 - 8000
                </div>
              </div>

              <!-- สิ่งอำนวยความสะดวก -->
              <div>
                <h4 class="font-medium text-gray-900 mb-2 sm:mb-3 font-thai text-sm sm:text-base">สิ่งอำนวยความสะดวก</h4>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-2 sm:gap-x-3">
                  <label 
                    *ngFor="let amenity of amenities" 
                    class="flex items-center cursor-pointer"
                    (click)="toggleAmenity(amenity); $event.stopPropagation()">
                    <div 
                      class="w-4 h-4 sm:w-5 sm:h-5 rounded mr-1.5 sm:mr-2 flex items-center justify-center flex-shrink-0"
                      [ngClass]="amenity.checked ? 'text-white' : 'border border-gray-300'"
                      [style.background-color]="amenity.checked ? '#FFCD22' : 'transparent'">
                      <svg 
                        *ngIf="amenity.checked"
                        xmlns="http://www.w3.org/2000/svg" 
                        fill="none" 
                        viewBox="0 0 24 24" 
                        stroke-width="3" 
                        stroke="white" 
                        class="w-2.5 h-2.5 sm:w-3 sm:h-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                      </svg>
                    </div>
                    <span class="font-thai text-xs sm:text-sm">{{ amenity.name }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-3 sm:p-4 border-t border-gray-200 flex justify-end gap-2 sm:gap-3 bg-white flex-shrink-0">
            <button 
              (click)="clearFilters()"
              class="btn-mobile px-4 sm:px-6 py-1.5 sm:py-2 bg-white text-red-500 rounded-lg hover:bg-gray-50 transition-colors font-thai font-medium text-sm sm:text-base">
              ล้าง
            </button>
            <button 
              (click)="applyFilters()"
              class="btn-mobile px-4 sm:px-6 py-1.5 sm:py-2 text-gray-800 rounded-lg transition-colors font-thai font-medium text-sm sm:text-base"
              style="background-color: #FFCD22;"
              onmouseover="this.style.backgroundColor='#F59E0B'"
              onmouseout="this.style.backgroundColor='#FFCD22'">
              ตกลง
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Results header -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-2 sm:gap-0">
  <div class="w-full sm:w-auto">
    <h2 class="page-header-mobile text-base sm:text-lg md:text-xl font-medium font-thai">
      <span *ngIf="similarSearchParams; else searchTitle">
        หอพักที่คล้ายกับ "{{ similarSearchParams.similarName }}"
      </span>
      <ng-template #searchTitle>
        <span *ngIf="searchQuery; else normalTitle">
          ผลลัพธ์การค้นหา: "{{ searchQuery }}"
        </span>
        <ng-template #normalTitle>
          พบข้อมูลหอพัก
        </ng-template>
      </ng-template>
      <span class="result-count text-gray-500 font-normal text-xs sm:text-sm ml-2">({{displayedDorms.length}}/{{filteredDorms.length}})</span>
    </h2>
    <div *ngIf="similarSearchParams" class="text-xs sm:text-sm text-gray-600 font-thai space-y-1 mt-1">
      <p class="line-clamp-2">
        <span class="font-medium">โซน:</span> {{ similarSearchParams.zone || 'ไม่ระบุ' }}
        <span class="mx-1 sm:mx-2">|</span>
        <span class="font-medium">ราคา:</span> {{ similarSearchParams.minPrice?.toLocaleString() || '0' }} - {{ similarSearchParams.maxPrice?.toLocaleString() || '0' }} บาท
      </p>
      <p *ngIf="similarSearchParams.amenities && similarSearchParams.amenities.length > 0" class="line-clamp-1">
        <span class="font-medium">สิ่งอำนวยความสะดวก:</span> {{ similarSearchParams.amenities.slice(0, 3).join(', ') }}
        <span *ngIf="similarSearchParams.amenities.length > 3">และอีก {{ similarSearchParams.amenities.length - 3 }} รายการ</span>
      </p>
      <button 
        (click)="clearSimilarSearch()"
        class="text-blue-600 hover:text-blue-800 text-xs sm:text-sm hover:underline transition-colors duration-200">
        ดูหอพักทั้งหมด
      </button>
    </div>
  </div>
</div>

  <!-- Skeleton while loading -->
  <div *ngIf="isLoading || isFiltering" class="dorm-grid-mobile dorm-grid-tablet grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
    <div *ngFor="let s of [1,2,3,4,5,6,7,8]" class="bg-white border border-black/10 rounded-lg p-3 sm:p-4 animate-pulse">
      <div class="w-full h-40 sm:h-48 mb-2 sm:mb-3 bg-gray-200 rounded-lg"></div>
      <div class="h-3 sm:h-4 bg-gray-200 rounded w-2/3 mb-1.5 sm:mb-2"></div>
      <div class="h-3 sm:h-4 bg-gray-200 rounded w-1/2 mb-1.5 sm:mb-2"></div>
      <div class="h-2.5 sm:h-3 bg-gray-200 rounded w-1/3 mb-2 sm:mb-3"></div>
      <div class="flex gap-1.5 sm:gap-2 mt-auto">
        <div class="w-4 h-4 sm:w-5 sm:h-5 bg-gray-200 rounded"></div>
        <div class="w-4 h-4 sm:w-5 sm:h-5 bg-gray-200 rounded"></div>
        <div class="w-4 h-4 sm:w-5 sm:h-5 bg-gray-200 rounded"></div>
        <div class="w-4 h-4 sm:w-5 sm:h-5 bg-gray-200 rounded"></div>
        <div class="w-4 h-4 sm:w-5 sm:h-5 bg-gray-200 rounded"></div>
      </div>
    </div>
  </div>

  <!-- Dorm grid (match main page card layout) -->
  <div *ngIf="!isLoading && !isFiltering" class="dorm-grid-mobile dorm-grid-tablet grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
    <ng-container *ngFor="let dorm of displayedDorms">
      <div
        class="dorm-card-mobile bg-white shadow hover:shadow-lg transition p-3 sm:p-4 flex flex-col border border-black/10 h-full card-hover-effect rounded-lg">
        <div class="card-image w-full h-40 sm:h-48 mb-2 sm:mb-3 overflow-hidden rounded-lg cursor-pointer" [routerLink]="['/dorm-detail', dorm.id]">
          <img [src]="dorm.image" alt="dorm"
            class="w-full h-full object-cover hover:scale-105 transition-transform duration-500" />
        </div>

        <div class="flex-1 flex flex-col">
          <div class="text-[#6D6D6D] font-bold text-sm sm:text-base flex items-start price-container h-[40px] sm:h-[48px] font-english"
            [innerHTML]="getSafePriceHtml(dorm.price)"></div>

          <div class="card-title font-medium text-base sm:text-lg mb-1 font-thai min-h-[48px] sm:min-h-[56px] line-clamp-2 cursor-pointer"
            [routerLink]="['/dorm-detail', dorm.id]">
            {{ dorm.name }}
          </div>

          <div class="card-zone text-gray-500 text-xs sm:text-sm mb-0.5 sm:mb-1 font-thai min-h-[18px] sm:min-h-[20px] line-clamp-2">{{ dorm.zone }}</div>

          <div class="card-date text-gray-400 text-[0.65rem] sm:text-xs font-thai mb-2 sm:mb-3">{{ dorm.date }}</div>

          <div class="mt-auto flex items-end">
            <div class="flex items-end">
              <span class="text-xs sm:text-sm font-bold text-gray-700 font-english relative top-0.5">{{ dorm.rating?.toFixed(1) || '0.0' }}</span>
              <span class="ml-2 sm:ml-3 flex relative top-[0.05rem]">
                <ng-container *ngFor="let star of getStars(dorm.rating)">
                  <svg xmlns="http://www.w3.org/2000/svg" [attr.fill]="star.filled ? '#FDD836' : '#E5E7EB'" viewBox="0 0 20 20" class="w-4 h-4 sm:w-5 sm:h-5 inline">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.967a1 1 0 00.95.69h4.175c.969 0 1.371 1.24.588 1.81l-3.38 2.455a1 1 0 00-.364 1.118l1.287 3.966c.3.922-.755 1.688-1.54 1.118l-3.38-2.454a1 1 0 00-1.175 0l-3.38 2.454c-.784.57-1.838-.196-1.54-1.118l1.287-3.966a1 1 0 00-.364-1.118L2.05 9.394c-.783-.57-.38-1.81.588-1.81h4.175a1 1 0 00.95-.69l1.286-3.967z" />
                  </svg>
                </ng-container>
              </span>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Load more button -->
  <div *ngIf="!isLoading && !isFiltering && showLoadMoreButton" class="text-center mt-6 sm:mt-8">
    <button 
      (click)="loadMoreDorms()"
      class="px-6 sm:px-8 py-2.5 sm:py-3 text-gray-800 rounded-lg transition-colors font-thai text-base sm:text-lg font-medium shadow-md sm:shadow-lg hover:shadow-xl"
      style="background-color: #FFCD22;"
      onmouseover="this.style.backgroundColor='#F59E0B'"
      onmouseout="this.style.backgroundColor='#FFCD22'">
      ดูหอพักทั้งหมด ({{filteredDorms.length - displayedDorms.length}} หอพักที่เหลือ)
    </button>
  </div>

  <!-- No results message -->
  <div *ngIf="!isLoading && !isFiltering && displayedDorms.length === 0" class="text-center py-8 sm:py-12">
    <div class="bg-white rounded-lg shadow-lg p-6 sm:p-8">
      <svg class="w-12 h-12 sm:w-16 sm:h-16 text-gray-400 mx-auto mb-3 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <p class="text-base sm:text-lg text-gray-600 font-thai">
        <span *ngIf="similarSearchParams; else searchNoResult">
          ไม่พบหอพักที่คล้ายกัน ลองปรับเกณฑ์การค้นหาหรือดูหอพักทั้งหมด
        </span>
        <ng-template #searchNoResult>
          <span *ngIf="searchQuery; else normalNoResult">
            ไม่พบหอพักที่ตรงกับคำค้นหา "{{ searchQuery }}"
          </span>
          <ng-template #normalNoResult>
            ไม่พบหอพักที่ตรงกับเงื่อนไข กรุณาปรับเกณฑ์การค้นหา
          </ng-template>
        </ng-template>
      </p>
      <div class="mt-3 sm:mt-4 space-x-2 sm:space-x-3">
        <button 
          *ngIf="similarSearchParams" 
          (click)="clearSimilarSearch()"
          class="px-4 sm:px-6 py-1.5 sm:py-2 text-sm sm:text-base text-gray-800 rounded-lg transition-colors font-thai"
          style="background-color: #FFCD22;"
          onmouseover="this.style.backgroundColor='#F59E0B'"
          onmouseout="this.style.backgroundColor='#FFCD22'">
          ดูหอพักทั้งหมด
        </button>
        <button 
          *ngIf="searchQuery" 
          (click)="clearSearch()"
          class="px-4 sm:px-6 py-1.5 sm:py-2 text-sm sm:text-base bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-thai">
          ล้างการค้นหา
        </button>
      </div>
    </div>
  </div>

  <!-- Compare Popup -->
  <app-compare-popup></app-compare-popup>
</div>